<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title data-i18n="title">批量影片字幕生成器</title>
  <script src="public/js/xlsx.full.min.js"></script>
  <link href="public/css/NotoSansFamilly.css" rel="stylesheet">
  <style>
    body { 
      font-family: 'Noto Sans', 'Noto Sans SC', 'Noto Sans TC', 'Noto Sans JP', 'Noto Sans KR', 'Noto Sans Devanagari', 'Noto Sans Thai', sans-serif; 
      max-width: 1200px; 
      margin: 2em auto; 
      line-height: 1.6; 
      padding: 0 20px;
      background-color: #f5f5f5;
    }
    .container { 
      background: white;
      border: 1px solid #ddd; 
      padding: 30px; 
      border-radius: 12px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1, h2, h3 { text-align: center; color: #333; }
    h1 { margin-bottom: 10px; }
    .subtitle { text-align: center; color: #666; margin-bottom: 30px; }
    #languageSelect {
      display: block;
      margin: 0 auto 20px;
      padding: 8px;
      font-size: 16px;
      border-radius: 6px;
      width: 200px;
    }
    .file-upload-wrapper {
      margin: 1.5em 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    input[type="file"] { 
      display: none;
    }
    button[data-i18n="browse"] {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }
    button[data-i18n="browse"]:hover {
      background-color: #0056b3;
    }
    #file-status {
      color: #666;
    }
    button { 
      padding: 12px 20px; 
      background-color: #007bff; 
      color: white; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 16px;
      margin: 5px;
    }
    button:hover { background-color: #0056b3; }
    button:disabled { 
      background-color: #6c757d; 
      cursor: not-allowed; 
    }
    #status-container { 
      background: white;
      padding: 25px; 
      border-radius: 12px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    #status-container p { margin: 0.8em 0; }
    .status-item { 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .status-item:last-child { border-bottom: none; }
    .status-value { 
      font-weight: bold; 
      color: #007bff; 
    }
    .upload-status { 
      margin-top: 15px; 
      padding: 10px; 
      border-radius: 6px; 
      text-align: center;
    }
    .upload-status.success { background-color: #d4edda; color: #155724; }
    .upload-status.error { background-color: #f8d7da; color: #721c24; }
    .upload-status.info { background-color: #cce7ff; color: #004085; }
    .progress-section {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #007bff;
    }
    .current-file {
      font-weight: bold;
      color: #007bff;
      margin-bottom: 10px;
    }
    .progress-step {
      margin: 5px 0;
      font-size: 14px;
    }
    #completed-videos-section {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
    }
    #completed-videos-section table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    #completed-videos-section th, #completed-videos-section td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }
    #completed-videos-section th {
      background-color: #007bff;
      color: white;
    }
    #completed-videos-section tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    #completed-videos-section tr:hover {
      background-color: #f1f1f1;
    }
    .subtitle-settings {
      margin: 1.5em 0;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #007bff;
    }
    .language-selector {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
    .language-checkbox {
      display: inline-block;
      margin: 5px 10px;
      padding: 8px;
    }
    .language-checkbox input[type="checkbox"] {
      margin-right: 8px;
    }
    .subtitle-language {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      display: none;
    }
    .subtitle-language.active {
      display: block;
    }
    .subtitle-language h3 {
      margin-top: 0;
      color: #007bff;
      text-align: left;
    }
    .setting-row {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .setting-row label {
      font-weight: bold;
      color: #333;
      min-width: 100px;
    }
    .setting-row select, 
    .setting-row input[type="number"], 
    .setting-row input[type="color"] {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
    }
    .setting-row input[type="number"] {
      width: 80px;
    }
    .setting-row input[type="color"] {
      width: 50px;
      height: 30px;
      padding: 2px;
    }
    .position-selector {
      display: flex;
      gap: 10px;
    }
    .position-selector label {
      display: flex;
      align-items: center;
      gap: 5px;
      font-weight: normal;
      min-width: auto;
    }
    .position-selector input[type="radio"] {
      margin: 0;
    }
    #subtitle-order {
      margin-top: 20px;
      padding: 15px;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
    .order-container {
      display: flex;
      gap: 20px;
      margin-top: 15px;
    }
    .order-section {
      flex: 1;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 6px;
      min-height: 100px;
    }
    .order-section h4 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #007bff;
      text-align: center;
    }
    .order-item {
      padding: 8px 12px;
      background-color: #007bff;
      color: white;
      border-radius: 6px;
      margin: 5px 0;
      cursor: move;
      display: block;
      user-select: none;
      text-align: center;
    }
    .order-item.dragging {
      opacity: 0.5;
    }
    .order-section.drop-target {
      background-color: #e3f2fd;
      border: 2px dashed #007bff;
    }
    .refresh-fonts-btn {
      background-color: #28a745;
      margin-left: 10px;
      padding: 6px 12px;
      font-size: 14px;
    }
    .refresh-fonts-btn:hover {
      background-color: #218838;
    }
  </style>
</head>
<body>
  <div class="container">
    <select id="languageSelect">
      <option value="en">English</option>
      <option value="fr">Français</option>
      <option value="es">Español</option>
      <option value="de">Deutsch</option>
      <option value="it">Italiano</option>
      <option value="zh-CN">简体中文</option>
      <option value="zh-TW" selected>繁體中文</option>
      <option value="ja">日本語</option>
      <option value="ko">한국어</option>
      <option value="hi">हिन्दी</option>
      <option value="th">ไทย</option>
    </select>
    <h1 data-i18n="title">批量影片字幕生成器</h1>
    <p class="subtitle" data-i18n="subtitle">選擇多個影片檔案，自動生成多語言字幕</p>
    
    <div class="file-upload-wrapper">
      <input type="file" id="video-files" accept="video/*" multiple>
      <button data-i18n="browse">瀏覽</button>
      <span id="file-status" data-i18n="noFilesSelected">無檔案選擇</span>
    </div>

    <div class="subtitle-settings">
      <h2 data-i18n="subtitleSettings">字幕設定</h2>
      
      <!-- Language Selection -->
      <div class="language-selector">
        <h3 data-i18n="selectLanguages">選擇要生成的字幕語言</h3>
        <div class="language-checkbox">
          <input type="checkbox" id="lang-zh-tw" value="zh-tw" checked>
          <label for="lang-zh-tw" data-i18n="zhTwLabel">繁體中文</label>
        </div>
        <div class="language-checkbox">
          <input type="checkbox" id="lang-zh-cn" value="zh-cn">
          <label for="lang-zh-cn" data-i18n="zhCnLabel">简体中文</label>
        </div>
        <div class="language-checkbox">
          <input type="checkbox" id="lang-en" value="en" checked>
          <label for="lang-en" data-i18n="enLabel">英文</label>
        </div>
        <div class="language-checkbox">
          <input type="checkbox" id="lang-fr" value="fr" checked>
          <label for="lang-fr" data-i18n="frLabel">法文</label>
        </div>
      </div>

      <!-- Individual Language Settings -->
      <div id="zh-tw-settings" class="subtitle-language active">
        <h3 data-i18n="zhTwLabel">繁體中文設定</h3>
        <div class="setting-row">
          <label data-i18n="fontLabel">字體</label>
          <select id="zh-tw-font">
            <option value="Noto Sans TC">Noto Sans TC</option>
            <option value="Arial">Arial</option>
            <option value="Times New Roman">Times New Roman</option>
          </select>
          <button class="refresh-fonts-btn" onclick="refreshFonts('zh-tw-font')" data-i18n="refreshFonts">🔄 刷新字體</button>
        </div>
        <div class="setting-row">
          <label data-i18n="sizeLabel">字體大小</label>
          <input type="number" id="zh-tw-size" min="10" max="48" step="2" value="24">
          <label data-i18n="colorLabel">顏色</label>
          <input type="color" id="zh-tw-color" value="#FFFF00">
        </div>
        <div class="setting-row">
          <label data-i18n="positionLabel">位置</label>
          <div class="position-selector">
            <label><input type="radio" name="zh-tw-position" value="top" checked> <span data-i18n="topPosition">上方</span></label>
            <label><input type="radio" name="zh-tw-position" value="bottom"> <span data-i18n="bottomPosition">下方</span></label>
          </div>
        </div>
      </div>

      <div id="zh-cn-settings" class="subtitle-language">
        <h3 data-i18n="zhCnLabel">简体中文設定</h3>
        <div class="setting-row">
          <label data-i18n="fontLabel">字體</label>
          <select id="zh-cn-font">
            <option value="Noto Sans SC">Noto Sans SC</option>
            <option value="Arial">Arial</option>
            <option value="Times New Roman">Times New Roman</option>
          </select>
          <button class="refresh-fonts-btn" onclick="refreshFonts('zh-cn-font')" data-i18n="refreshFonts">🔄 刷新字體</button>
        </div>
        <div class="setting-row">
          <label data-i18n="sizeLabel">字體大小</label>
          <input type="number" id="zh-cn-size" min="10" max="48" step="2" value="22">
          <label data-i18n="colorLabel">顏色</label>
          <input type="color" id="zh-cn-color" value="#00FF00">
        </div>
        <div class="setting-row">
          <label data-i18n="positionLabel">位置</label>
          <div class="position-selector">
            <label><input type="radio" name="zh-cn-position" value="top" checked> <span data-i18n="topPosition">上方</span></label>
            <label><input type="radio" name="zh-cn-position" value="bottom"> <span data-i18n="bottomPosition">下方</span></label>
          </div>
        </div>
      </div>

      <div id="en-settings" class="subtitle-language active">
        <h3 data-i18n="enLabel">英文設定</h3>
        <div class="setting-row">
          <label data-i18n="fontLabel">字體</label>
          <select id="en-font">
            <option value="Arial">Arial</option>
            <option value="Noto Sans TC">Noto Sans TC</option>
            <option value="Times New Roman">Times New Roman</option>
          </select>
          <button class="refresh-fonts-btn" onclick="refreshFonts('en-font')" data-i18n="refreshFonts">🔄 刷新字體</button>
        </div>
        <div class="setting-row">
          <label data-i18n="sizeLabel">字體大小</label>
          <input type="number" id="en-size" min="10" max="48" step="2" value="20">
          <label data-i18n="colorLabel">顏色</label>
          <input type="color" id="en-color" value="#FFFFFF">
        </div>
        <div class="setting-row">
          <label data-i18n="positionLabel">位置</label>
          <div class="position-selector">
            <label><input type="radio" name="en-position" value="top" checked> <span data-i18n="topPosition">上方</span></label>
            <label><input type="radio" name="en-position" value="bottom"> <span data-i18n="bottomPosition">下方</span></label>
          </div>
        </div>
      </div>

      <div id="fr-settings" class="subtitle-language active">
        <h3 data-i18n="frLabel">法文設定</h3>
        <div class="setting-row">
          <label data-i18n="fontLabel">字體</label>
          <select id="fr-font">
            <option value="Times New Roman">Times New Roman</option>
            <option value="Noto Sans TC">Noto Sans TC</option>
            <option value="Arial">Arial</option>
          </select>
          <button class="refresh-fonts-btn" onclick="refreshFonts('fr-font')" data-i18n="refreshFonts">🔄 刷新字體</button>
        </div>
        <div class="setting-row">
          <label data-i18n="sizeLabel">字體大小</label>
          <input type="number" id="fr-size" min="10" max="48" step="2" value="20">
          <label data-i18n="colorLabel">顏色</label>
          <input type="color" id="fr-color" value="#00FFFF">
        </div>
        <div class="setting-row">
          <label data-i18n="positionLabel">位置</label>
          <div class="position-selector">
            <label><input type="radio" name="fr-position" value="top" checked> <span data-i18n="topPosition">上方</span></label>
            <label><input type="radio" name="fr-position" value="bottom"> <span data-i18n="bottomPosition">下方</span></label>
          </div>
        </div>
      </div>

      <!-- Subtitle Order -->
      <div id="subtitle-order">
        <h3 data-i18n="orderLabel">字幕排列順序</h3>
        <p data-i18n="orderInstructions">拖曳調整字幕在同一位置（上方或下方）的顯示順序</p>
        <div class="order-container">
          <div class="order-section" id="top-order">
            <h4 data-i18n="topOrderLabel">上方字幕順序</h4>
          </div>
          <div class="order-section" id="bottom-order">
            <h4 data-i18n="bottomOrderLabel">下方字幕順序</h4>
          </div>
        </div>
      </div>
    </div>

    <div style="text-align: center;">
      <button onclick="uploadVideos()" id="upload-btn" data-i18n="uploadButton">📤 上傳並開始處理</button>
    </div>
    <div id="upload-status-container"></div>
  </div>

  <div id="status-container">
    <h2 data-i18n="statusTitle">📊 處理狀態</h2>
    <div class="status-item">
      <span data-i18n="queueLabel"><strong>隊列中的影片：</strong></span>
      <span class="status-value" id="queue-count">0</span>
    </div>
    <div class="status-item">
      <span data-i18n="pendingLabel"><strong>待處理檔案：</strong></span>
      <span class="status-value" id="pending-count">0</span>
    </div>
    <div class="status-item">
      <span data-i18n="completedLabel"><strong>已完成影片：</strong></span>
      <span class="status-value" id="completed-count">0</span>
    </div>
    <div class="status-item">
      <span data-i18n="processingLabel"><strong>處理狀態：</strong></span>
      <span class="status-value" id="processing-status">空閒</span>
    </div>
    <div id="progress-section" class="progress-section" style="display: none;">
      <div class="current-file" id="current-file"></div>
      <div class="progress-step" id="progress-step"></div>
    </div>
    <div id="completed-videos-section">
      <h2 data-i18n="completedTitle">📋 已完成影片</h2>
      <table id="completed-videos-table">
        <thead>
          <tr>
            <th data-i18n="tableOriginalFile">原始檔案</th>
            <th data-i18n="tableNewFile">新檔案</th>
            <th data-i18n="tableLanguages">字幕語言</th>
            <th data-i18n="tableDuration">轉換耗時（秒）</th>
          </tr>
        </thead>
        <tbody id="completed-videos-body"></tbody>
      </table>
      <div style="text-align: center; margin-top: 20px;">
        <button onclick="exportToExcel()" data-i18n="exportButton">📥 匯出為 Excel</button>
      </div>
    </div>
    <div style="text-align: center; margin-top: 20px;">
      <button onclick="fetchStatus()" data-i18n="refreshButton">🔄 刷新狀態</button>
    </div>
  </div>

  <script>
    const translations = {
      en: {
        title: "Batch Video Subtitle Generator",
        subtitle: "Select multiple video files to automatically generate multilingual subtitles",
        uploadButton: "📤 Upload and Start Processing",
        statusTitle: "📊 Processing Status",
        queueLabel: "Videos in Queue:",
        pendingLabel: "Pending Files:",
        completedLabel: "Completed Videos:",
        completedTitle: "📋 Completed Videos",
        processingLabel: "Processing Status:",
        tableOriginalFile: "Original File",
        tableNewFile: "New File",
        tableLanguages: "Subtitle Languages",
        tableDuration: "Processing Time (seconds)",
        exportButton: "📥 Export to Excel",
        refreshButton: "🔄 Refresh Status",
        noData: "No completed videos yet",
        browse: "Browse",
        noFilesSelected: "No files selected",
        uploadSelect: "Please select video files to upload",
        uploadProcessing: "Uploading {count} file(s)...",
        uploadSuccess: "Upload successful",
        uploadError: "Upload failed, please try again",
        exportNoData: "No data to export",
        exportSuccess: "Completed videos list exported",
        statusError: "Failed to fetch status",
        processingIdle: "Idle",
        processingQueue: "Waiting in queue",
        subtitleSettings: "Subtitle Settings",
        selectLanguages: "Select Subtitle Languages",
        zhTwLabel: "Traditional Chinese",
        zhCnLabel: "Simplified Chinese",
        enLabel: "English",
        frLabel: "French",
        fontLabel: "Font",
        sizeLabel: "Font Size",
        colorLabel: "Color",
        positionLabel: "Position",
        topPosition: "Top",
        bottomPosition: "Bottom",
        orderLabel: "Subtitle Display Order",
        orderInstructions: "Drag to adjust subtitle order within the same position (top or bottom)",
        topOrderLabel: "Top Subtitles Order",
        bottomOrderLabel: "Bottom Subtitles Order",
        refreshFonts: "🔄 Refresh Fonts"
      },
      'zh-TW': {
        title: "批量影片字幕生成器",
        subtitle: "選擇多個影片檔案，自動生成多語言字幕",
        uploadButton: "📤 上傳並開始處理",
        statusTitle: "📊 處理狀態",
        queueLabel: "隊列中的影片：",
        pendingLabel: "待處理檔案：",
        completedLabel: "已完成影片：",
        processingLabel: "處理狀態：",
        tableOriginalFile: "原始檔案",
        tableNewFile: "新檔案",
        tableLanguages: "字幕語言",
        tableDuration: "轉換耗時（秒）",
        exportButton: "📥 匯出為 Excel",
        refreshButton: "🔄 刷新狀態",
        noData: "暫無已完成影片",
        browse: "瀏覽",
        noFilesSelected: "無檔案選擇",
        uploadSelect: "請選擇要上傳的影片檔案",
        uploadProcessing: "正在上傳 {count} 個檔案...",
        uploadSuccess: "上傳成功",
        uploadError: "上傳失敗，請重試",
        exportNoData: "暫無資料可匯出",
        exportSuccess: "已匯出完成影片列表",
        statusError: "狀態獲取失敗",
        processingIdle: "空閒",
        processingQueue: "隊列等待中",
        subtitleSettings: "字幕設定",
        selectLanguages: "選擇要生成的字幕語言",
        zhTwLabel: "繁體中文",
        zhCnLabel: "简体中文",
        enLabel: "英文",
        frLabel: "法文",
        fontLabel: "字體",
        sizeLabel: "字體大小",
        colorLabel: "顏色",
        positionLabel: "位置",
        topPosition: "上方",
        bottomPosition: "下方",
        orderLabel: "字幕排列順序",
        orderInstructions: "拖曳調整字幕在同一位置（上方或下方）的顯示順序",
        topOrderLabel: "上方字幕順序",
        bottomOrderLabel: "下方字幕順序",
        refreshFonts: "🔄 刷新字體"
      }
    };

    let eventSource = null;
    let currentLanguage = 'zh-TW';
    let availableFonts = [];

    // Load available fonts on page load
    async function loadAvailableFonts() {
      try {
        const response = await fetch('/api/fonts');
        availableFonts = await response.json();
        updateFontSelects();
      } catch (error) {
        console.error('Failed to load fonts:', error);
      }
    }

    function updateFontSelects() {
      const fontSelects = document.querySelectorAll('select[id$="-font"]');
      fontSelects.forEach(select => {
        const currentValue = select.value;
        // Keep existing options and add new ones
        const existingOptions = Array.from(select.options).map(opt => opt.value);
        availableFonts.forEach(font => {
          if (!existingOptions.includes(font.name)) {
            const option = document.createElement('option');
            option.value = font.name;
            option.textContent = font.name;
            select.appendChild(option);
          }
        });
        // Restore selected value
        if (existingOptions.includes(currentValue)) {
          select.value = currentValue;
        }
      });
    }

    async function refreshFonts(selectId) {
      await loadAvailableFonts();
      showUploadStatus('字體列表已更新', 'success');
    }

    function setLanguage(lang) {
      currentLanguage = lang;
      updateTranslations();
    }

    function updateTranslations() {
      document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[currentLanguage] && translations[currentLanguage][key]) {
          element.textContent = translations[currentLanguage][key];
        }
      });
      updateFileStatus();
      fetchStatus();
    }

    let currentProgress = {};

    // Language checkbox handlers
    document.addEventListener('change', (e) => {
      if (e.target.type === 'checkbox' && e.target.id.startsWith('lang-')) {
        const lang = e.target.value;
        const settingsDiv = document.getElementById(`${lang}-settings`);
        if (e.target.checked) {
          settingsDiv.classList.add('active');
          // Add to appropriate order list
          const position = document.querySelector(`input[name="${lang}-position"]:checked`).value;
          addToOrderList(lang, position);
        } else {
          settingsDiv.classList.remove('active');
          // Remove from order lists
          removeFromOrderLists(lang);
        }
      }
    });

    // Position radio button handlers
    document.addEventListener('change', (e) => {
      if (e.target.type === 'radio' && e.target.name.endsWith('-position')) {
        const lang = e.target.name.replace('-position', '');
        const isChecked = document.getElementById(`lang-${lang}`).checked;
        if (isChecked) {
          removeFromOrderLists(lang);
          addToOrderList(lang, e.target.value);
        }
      }
    });

    function addToOrderList(lang, position) {
      const orderList = document.getElementById(`${position}-order`);
      const existingItem = orderList.querySelector(`[data-lang="${lang}"]`);
      if (!existingItem) {
        const orderItem = document.createElement('div');
        orderItem.className = 'order-item';
        orderItem.draggable = true;
        orderItem.dataset.lang = lang;
        orderItem.textContent = translations[currentLanguage][`${lang.replace('-', '')}Label`] || lang;
        orderList.appendChild(orderItem);
      }
    }

    function removeFromOrderLists(lang) {
      const topOrder = document.getElementById('top-order');
      const bottomOrder = document.getElementById('bottom-order');
      [topOrder, bottomOrder].forEach(list => {
        const item = list.querySelector(`[data-lang="${lang}"]`);
        if (item) {
          item.remove();
        }
      });
    }

    // Initialize order lists
    function initializeOrderLists() {
      const checkedLanguages = document.querySelectorAll('input[type="checkbox"][id^="lang-"]:checked');
      checkedLanguages.forEach(checkbox => {
        const lang = checkbox.value;
        const position = document.querySelector(`input[name="${lang}-position"]:checked`).value;
        addToOrderList(lang, position);
      });
    }

    document.getElementById('languageSelect').addEventListener('change', (e) => {
      setLanguage(e.target.value);
    });

    document.querySelector('button[data-i18n="browse"]').addEventListener('click', () => {
      document.getElementById('video-files').click();
    });

    document.getElementById('video-files').addEventListener('change', () => {
      updateFileStatus();
    });

    function updateFileStatus() {
      const fileInput = document.getElementById('video-files');
      const fileStatus = document.getElementById('file-status');
      if (fileInput.files.length > 0) {
        fileStatus.textContent = `${fileInput.files.length} ${translations[currentLanguage].uploadProcessing ? translations[currentLanguage].uploadProcessing.split(' ')[1] : 'files selected'}`;
      } else {
        fileStatus.textContent = translations[currentLanguage].noFilesSelected;
      }
    }

    function showUploadStatus(message, type = 'info') {
      const container = document.getElementById('upload-status-container');
      message = message.replace('{count}', document.getElementById('video-files').files.length);
      container.innerHTML = `<div class="upload-status ${type}">${message}</div>`;
    }

    function getSubtitleSettings() {
      const selectedLanguages = Array.from(document.querySelectorAll('input[type="checkbox"][id^="lang-"]:checked'))
        .map(cb => cb.value);
      
      const settings = {
        languages: selectedLanguages,
        configs: {}
      };

      selectedLanguages.forEach(lang => {
        const position = document.querySelector(`input[name="${lang}-position"]:checked`).value;
        settings.configs[lang] = {
          font: document.getElementById(`${lang}-font`).value,
          size: parseInt(document.getElementById(`${lang}-size`).value),
          color: document.getElementById(`${lang}-color`).value,
          position: position
        };
      });

      // Get order for each position
      const topOrder = Array.from(document.querySelectorAll('#top-order .order-item'))
        .map(item => item.dataset.lang);
      const bottomOrder = Array.from(document.querySelectorAll('#bottom-order .order-item'))
        .map(item => item.dataset.lang);

      settings.order = {
        top: topOrder,
        bottom: bottomOrder
      };

      return settings;
    }

    function uploadVideos() {
      const files = document.getElementById('video-files').files;
      const uploadBtn = document.getElementById('upload-btn');
      
      if (files.length === 0) {
        showUploadStatus(translations[currentLanguage].uploadSelect, 'error');
        return;
      }

      const selectedLanguages = Array.from(document.querySelectorAll('input[type="checkbox"][id^="lang-"]:checked'));
      if (selectedLanguages.length === 0) {
        showUploadStatus('請至少選擇一種字幕語言', 'error');
        return;
      }

      const formData = new FormData();
      for (const file of files) {
        formData.append('videos', file);
      }

      const subtitleSettings = getSubtitleSettings();
      formData.append('subtitleSettings', JSON.stringify(subtitleSettings));

      uploadBtn.disabled = true;
      uploadBtn.textContent = translations[currentLanguage].uploadButton.replace('📤 ', '⏳ ');
      showUploadStatus(translations[currentLanguage].uploadProcessing, 'info');

      fetch('/upload', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        showUploadStatus(translations[currentLanguage].uploadSuccess, 'success');
        fetchStatus();
        startProgressStreaming();
        document.getElementById('video-files').value = '';
        updateFileStatus();
      })
      .catch(error => {
        console.error('Upload error:', error);
        showUploadStatus(translations[currentLanguage].uploadError, 'error');
      })
      .finally(() => {
        uploadBtn.disabled = false;
        uploadBtn.textContent = translations[currentLanguage].uploadButton;
      });
    }

    function fetchStatus() {
      fetch('/status')
      .then(response => response.json())
      .then(data => {
        document.getElementById('queue-count').textContent = data.queue.length;
        document.getElementById('pending-count').textContent = data.pending;
        document.getElementById('completed-count').textContent = data.completed;
        
        const processingStatus = document.getElementById('processing-status');
        if (data.isProcessing && data.currentFile) {
          processingStatus.textContent = `${translations[currentLanguage].processingLabel} ${data.currentFile}`;
          processingStatus.style.color = '#28a745';
        } else if (data.queue.length > 0) {
          processingStatus.textContent = translations[currentLanguage].processingQueue;
          processingStatus.style.color = '#ffc107';
        } else {
          processingStatus.textContent = translations[currentLanguage].processingIdle;
          processingStatus.style.color = '#6c757d';
        }

        const completedVideosBody = document.getElementById('completed-videos-body');
        completedVideosBody.innerHTML = '';
        if (data.completedVideos && data.completedVideos.length > 0) {
          data.completedVideos.forEach(video => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${video.originalFile}</td>
              <td>${video.newFile}</td>
              <td>${video.languages ? video.languages.join(', ') : 'N/A'}</td>
              <td>${video.duration.toFixed(2)}</td>
            `;
            completedVideosBody.appendChild(row);
          });
        } else {
          const row = document.createElement('tr');
          row.innerHTML = `<td colspan="4" style="text-align: center;">${translations[currentLanguage].noData}</td>`;
          completedVideosBody.appendChild(row);
        }
      })
      .catch(error => {
        console.error('Error fetching status:', error);
        document.getElementById('processing-status').textContent = translations[currentLanguage].statusError;
      });
    }

    function exportToExcel() {
      const table = document.getElementById('completed-videos-table');
      const data = [];
      
      data.push([
        translations[currentLanguage].tableOriginalFile,
        translations[currentLanguage].tableNewFile,
        translations[currentLanguage].tableLanguages,
        translations[currentLanguage].tableDuration
      ]);
      
      const tbody = document.getElementById('completed-videos-body');
      const dataRows = tbody.querySelectorAll('tr');
      dataRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length === 4) {
          const rowData = [
            cells[0].textContent,
            cells[1].textContent,
            cells[2].textContent,
            cells[3].textContent
          ];
          data.push(rowData);
        }
      });

      if (data.length === 1) {
        showUploadStatus(translations[currentLanguage].exportNoData, 'info');
        return;
      }

      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Completed Videos');
      XLSX.writeFile(wb, `completed_videos_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.xlsx`);
      showUploadStatus(translations[currentLanguage].exportSuccess, 'success');
    }

    function startProgressStreaming() {
      if (eventSource) {
        eventSource.close();
      }

      eventSource = new EventSource('/api/process-progress');
      
      eventSource.onmessage = function(event) {
        try {
          const progress = JSON.parse(event.data);
          currentProgress = progress;
          updateProgressDisplay(progress);
        } catch (error) {
          console.error('Error parsing progress data:', error);
        }
      };

      eventSource.onerror = function(error) {
        console.error('EventSource error:', error);
        setTimeout(() => {
          if (document.getElementById('pending-count').textContent !== '0') {
            startProgressStreaming();
          }
        }, 5000);
      };
    }

    function updateProgressDisplay(progress) {
      const progressSection = document.getElementById('progress-section');
      const currentFileEl = document.getElementById('current-file');
      const progressStepEl = document.getElementById('progress-step');
      
      if (progress.currentFile) {
        progressSection.style.display = 'block';
        currentFileEl.textContent = `${translations[currentLanguage].processingLabel} ${progress.currentFile}`;
        
        let stepText = `Processing: ${progress.step}`;
        if (progress.progress !== undefined) {
          stepText += ` (${Math.round(progress.progress * 100)}%)`;
        }
        
        if (progress.videoIndex !== undefined && progress.totalVideos !== undefined) {
          stepText = `[${progress.videoIndex + 1}/${progress.totalVideos}] ${stepText}`;
        }
        
        progressStepEl.textContent = stepText;
      } else {
        progressSection.style.display = 'none';
      }
      
      if (progress.queueLength !== undefined) {
        document.getElementById('queue-count').textContent = progress.queueLength;
      }
      
      if (progress.step === 'merging_subtitles' && progress.progress === 1.0) {
        setTimeout(fetchStatus, 1000);
      }
    }

    // Drag and drop functionality
    function setupDragAndDrop() {
      const orderSections = document.querySelectorAll('.order-section');
      
      orderSections.forEach(section => {
        section.addEventListener('dragover', (e) => {
          e.preventDefault();
          section.classList.add('drop-target');
        });

        section.addEventListener('dragleave', (e) => {
          if (!section.contains(e.relatedTarget)) {
            section.classList.remove('drop-target');
          }
        });

        section.addEventListener('drop', (e) => {
          e.preventDefault();
          section.classList.remove('drop-target');
          
          const draggedLang = e.dataTransfer.getData('text/plain');
          const draggedItem = document.querySelector(`.order-item[data-lang="${draggedLang}"]`);
          
          if (draggedItem && section.id !== draggedItem.parentElement.id) {
            // Move item to new section
            section.appendChild(draggedItem);
            
            // Update radio button
            const radio = document.querySelector(`input[name="${draggedLang}-position"][value="${section.id.replace('-order', '')}"]`);
            if (radio) {
              radio.checked = true;
            }
          } else if (draggedItem && section.id === draggedItem.parentElement.id) {
            // Reorder within same section
            const dropTarget = e.target.closest('.order-item');
            if (dropTarget && dropTarget !== draggedItem) {
              const allItems = Array.from(section.querySelectorAll('.order-item'));
              const fromIndex = allItems.indexOf(draggedItem);
              const toIndex = allItems.indexOf(dropTarget);
              if (fromIndex < toIndex) {
                dropTarget.after(draggedItem);
              } else {
                dropTarget.before(draggedItem);
              }
            }
          }
        });
      });

      // Handle drag start and end for order items
      document.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('order-item')) {
          e.target.classList.add('dragging');
          e.dataTransfer.setData('text/plain', e.target.dataset.lang);
        }
      });

      document.addEventListener('dragend', (e) => {
        if (e.target.classList.contains('order-item')) {
          e.target.classList.remove('dragging');
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadAvailableFonts();
      initializeOrderLists();
      setupDragAndDrop();
      setLanguage(currentLanguage);
      fetchStatus();
      
      setTimeout(() => {
        const pendingCount = parseInt(document.getElementById('pending-count').textContent);
        if (pendingCount > 0) {
          startProgressStreaming();
        }
      }, 1000);
      
      setInterval(fetchStatus, 30000);
    });

    window.addEventListener('beforeunload', () => {
      if (eventSource) {
        eventSource.close();
      }
    });
  </script>
</body>
</html>
